<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo VIP Bolivia</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
</head>
<body>
    <div class="background-video-container">
        <video autoplay muted loop id="background-video">
            <source src="fondo-casino-3d.mp4" type="video/mp4">
            Tu navegador no soporta videos HTML5.
        </video>
    </div>

    <section id="splash-screen" class="app-screen">
        <div class="content-overlay">
            <img src="logo-bingo-vip.png" alt="Logo Bingo VIP Bolivia" class="app-logo">
            <h1 class="welcome-title" id="welcomeTitle">BIENVENIDO A BINGO VIP BOLIVIA</h1>
            <p class="slogan" id="sloganText">Tu destino definitivo para la diversión y grandes premios</p>
            <div class="loading-bar-container" id="loading-bar-container">
                <div class="loading-bar" id="loading-bar"></div>
                <span id="loading-percentage">0%</span>
            </div>
            <p class="loading-message" id="loadingMessage">Cargando recursos...</p>
        </div>
    </section>

    <section id="login-screen" class="app-screen hidden">
        <div class="content-overlay">
            <img src="logo-bingo-vip.png" alt="Logo Bingo VIP Bolivia" class="app-logo">
            <h1 class="welcome-title" id="loginTitle">INICIAR SESIÓN</h1>
            <div class="auth-section">
                <div class="input-group">
                    <input type="email" id="login-email" placeholder="Correo electrónico" required>
                </div>
                <div class="input-group">
                    <input type="password" id="login-password" placeholder="Contraseña" required>
                </div>
                <div class="botones-container">
                    <button class="btn-primary" id="login-button">INICIAR SESIÓN</button>
                    <button class="btn-accion-secondary" id="register-from-login-button">REGISTRARSE</button>
                </div>
                <p class="error-message" id="login-error-message"></p>
                <div class="bottom-area">
                    <p id="forgotPasswordText">¿Olvidaste tu contraseña? <a href="#" id="forgot-password-link">Recuperar</a></p>
                    <p id="termsLoginText">Al iniciar sesión, aceptas nuestros <a href="#" id="terms-login-link">Términos y Condiciones</a>.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="register-screen" class="app-screen hidden">
        <div class="content-overlay">
            <img src="logo-bingo-vip.png" alt="Logo Bingo VIP Bolivia" class="app-logo">
            <h1 class="welcome-title" id="registerTitle">REGISTRARSE</h1>
            <div class="auth-section">
                <div class="input-group">
                    <input type="text" id="register-name" placeholder="Nombre Completo" required>
                </div>
                <div class="input-group">
                    <input type="email" id="register-email" placeholder="Correo electrónico" required>
                </div>
                <div class="input-group">
                    <input type="password" id="register-password" placeholder="Contraseña" required>
                </div>
                <div class="input-group">
                    <input type="password" id="register-confirm-password" placeholder="Confirmar Contraseña" required>
                </div>
                <div class="botones-container">
                    <button class="btn-primary" id="register-button">CREAR CUENTA</button>
                    <button class="btn-accion-secondary" id="login-from-register-button">YA TENGO CUENTA</button>
                </div>
                <p class="error-message" id="register-error-message"></p>
                <div class="bottom-area">
                    <p id="termsRegisterText">Al registrarte, aceptas nuestros <a href="#" id="terms-register-link">Términos y Condiciones</a>.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="lobby-screen" class="app-screen hidden">
        <header class="lobby-header">
            <button class="back-button" id="lobby-back-button">
                <i class="fas fa-arrow-left"></i> <span id="lobbyBackText">Volver a Inicio</span>
            </button>
            <div class="user-info">
                <img src="avatar_default.png" alt="Avatar Usuario" class="avatar-circle" id="user-avatar">
                <span class="user-balance" id="user-balance">$0.00</span>
                <button class="add-funds-button" id="add-funds-button">
                    <i class="fas fa-plus-circle"></i>
                </button>
            </div>
            <button class="settings-button" id="settings-button">
                <i class="fas fa-cog"></i> <span id="settingsText">Configuración</span>
            </button>
        </header>

        <h1 class="screen-title" id="lobbyTitle">SELECCIONA TU SALA DE JUEGO</h1>

        <div class="salas-grid">
            <div class="sala-card" id="sala-1" data-cost="1" data-prize="3" data-min-balance="1" data-name="El Subterráneo" data-min-players="5" data-max-players="8">
                <div class="sala-card-background" style="background-image: url('fondo-sala-1.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N1</span>
                    <h2 class="sala-name">El Subterráneo</h2>
                    <p class="sala-description">El inicio, desde lo más profundo.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $1</span>
                        <span class="premio">Premio: $3</span>
                        <span class="players"><i class="fas fa-users"></i> 5/8</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-1"><span id="playSala1">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

            <div class="sala-card" id="sala-2" data-cost="2" data-prize="6" data-min-balance="2" data-name="La Esquina Peligrosa" data-min-players="8" data-max-players="12">
                <div class="sala-card-background" style="background-image: url('fondo-sala-2.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N2</span>
                    <h2 class="sala-name">La Esquina Peligrosa</h2>
                    <p class="sala-description">La lucha diaria en las calles.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $2</span>
                        <span class="premio">Premio: $6</span>
                        <span class="players"><i class="fas fa-users"></i> 8/12</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-2"><span id="playSala2">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

            <div class="sala-card" id="sala-3" data-cost="3" data-prize="9" data-min-balance="3" data-name="El Aguantadero" data-min-players="10" data-max-players="15">
                <div class="sala-card-background" style="background-image: url('fondo-sala-3.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N3</span>
                    <h2 class="sala-name">El Aguantadero</h2>
                    <p class="sala-description">Donde la supervivencia es la clave.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $3</span>
                        <span class="premio">Premio: $9</span>
                        <span class="players"><i class="fas fa-users"></i> 10/15</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-3"><span id="playSala3">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

            <div class="sala-card" id="sala-4" data-cost="5" data-prize="15" data-min-balance="5" data-name="El Resbalón" data-min-players="12" data-max-players="18">
                <div class="sala-card-background" style="background-image: url('fondo-sala-4.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N4</span>
                    <h2 class="sala-name">El Resbalón</h2>
                    <p class="sala-description">Cuidado con las trampas en el camino.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $5</span>
                        <span class="premio">Premio: $15</span>
                        <span class="players"><i class="fas fa-users"></i> 12/18</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-4"><span id="playSala4">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

            <div class="sala-card" id="sala-5" data-cost="10" data-prize="30" data-min-balance="10" data-name="El Amanecer" data-min-players="15" data-max-players="20">
                <div class="sala-card-background" style="background-image: url('fondo-sala-5.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N5</span>
                    <h2 class="sala-name">El Amanecer</h2>
                    <p class="sala-description">El rayo de esperanza y nuevas oportunidades.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $10</span>
                        <span class="premio">Premio: $30</span>
                        <span class="players"><i class="fas fa-users"></i> 15/20</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-5"><span id="playSala5">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

            <div class="sala-card" id="sala-6" data-cost="20" data-prize="60" data-min-balance="20" data-name="El Dorado Cruceño" data-min-players="18" data-max-players="25">
                <div class="sala-card-background" style="background-image: url('fondo-sala-6.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N6</span>
                    <h2 class="sala-name">El Dorado Cruceño</h2>
                    <p class="sala-description">Donde el progreso y el orgullo se encuentran.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $20</span>
                        <span class="premio">Premio: $60</span>
                        <span class="players"><i class="fas fa-users"></i> 18/25</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-6"><span id="playSala6">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

            <div class="sala-card" id="sala-7" data-cost="50" data-prize="150" data-min-balance="50" data-name="La Joya Escondida" data-min-players="20" data-max-players="30">
                <div class="sala-card-background" style="background-image: url('fondo-sala-7.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N7</span>
                    <h2 class="sala-name">La Joya Escondida</h2>
                    <p class="sala-description">Acceso a lo exclusivo, solo para unos pocos.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $50</span>
                        <span class="premio">Premio: $150</span>
                        <span class="players"><i class="fas fa-users"></i> 20/30</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-7"><span id="playSala7">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

            <div class="sala-card" id="sala-8" data-cost="100" data-prize="300" data-min-balance="100" data-name="El Palacio de las Palmas" data-min-players="25" data-max-players="35">
                <div class="sala-card-background" style="background-image: url('fondo-sala-8.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N8</span>
                    <h2 class="sala-name">El Palacio de las Palmas</h2>
                    <p class="sala-description">La opulencia máxima, donde los sueños se hacen realidad.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $100</span>
                        <span class="premio">Premio: $300</span>
                        <span class="players"><i class="fas fa-users"></i> 25/35</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-8"><span id="playSala8">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

            <div class="sala-card" id="sala-9" data-cost="200" data-prize="600" data-min-balance="200" data-name="El Imperio Dorado" data-min-players="30" data-max-players="40">
                <div class="sala-card-background" style="background-image: url('fondo-sala-9.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N9</span>
                    <h2 class="sala-name">El Imperio Dorado</h2>
                    <p class="sala-description">El poder y la riqueza consolidada, la cima al alcance.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $200</span>
                        <span class="premio">Premio: $600</span>
                        <span class="players"><i class="fas fa-users"></i> 30/40</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-9"><span id="playSala9">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

            <div class="sala-card" id="sala-10" data-cost="500" data-prize="1500" data-min-balance="500" data-name="La Cima del Mundo" data-min-players="35" data-max-players="45">
                <div class="sala-card-background" style="background-image: url('fondo-sala-10.jpg');"></div>
                <div class="sala-card-content">
                    <span class="sala-level">N10</span>
                    <h2 class="sala-name">La Cima del Mundo</h2>
                    <p class="sala-description">Donde las dificultades de la cima ponen a prueba a los millonarios.</p>
                    <div class="sala-details">
                        <span class="costo">Costo: $500</span>
                        <span class="premio">Premio: $1500</span>
                        <span class="players"><i class="fas fa-users"></i> 35/45</span>
                    </div>
                    <button class="btn-bingo" data-sala-id="sala-10"><span id="playSala10">JUGAR EN ESTA SALA</span></button>
                </div>
            </div>

        </div>

        <div class="advertencia-legal" id="legalWarningText">
            <p>Juego con responsabilidad. Solo para mayores de 18 años.</p>
        </div>
    </section>

    <div class="music-controls">
        <button id="play-music-button"><i class="fas fa-play"></i></button>
        <button id="pause-music-button" class="hidden"><i class="fas fa-pause"></i></button>
        <audio id="background-music" loop>
            <source src="fondo.mp3" type="audio/mpeg">
            Tu navegador no soporta el elemento de audio.
        </audio>
    </div>

    <div class="language-selector">
        <select id="language-select">
            <option value="es">Español</option>
            <option value="en">English</option>
        </select>
    </div>

    <script>
        // script.js - INTEGRADO AQUI
        // Asegúrate de que Firebase Auth y DB estén disponibles globalmente
        // Esto se configura en firebase-config.js y se carga antes.

        document.addEventListener('DOMContentLoaded', () => {
            const splashScreen = document.getElementById('splash-screen');
            const loginScreen = document.getElementById('login-screen');
            const registerScreen = document.getElementById('register-screen');
            const lobbyScreen = document.getElementById('lobby-screen');
            const gameScreen = document.getElementById('game-screen'); // Para futura referencia
            
            // Elementos de Splash Screen
            const loadingBarContainer = document.getElementById('loading-bar-container');
            const loadingBar = document.getElementById('loading-bar');
            const loadingPercentage = document.getElementById('loading-percentage');
            const startButton = document.getElementById('start-game-button'); // Botón para iniciar el juego (después de la carga)

            // Elementos de Login Screen
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const loginButton = document.getElementById('login-button');
            const registerFromLoginButton = document.getElementById('register-from-login-button');
            const loginErrorMessage = document.getElementById('login-error-message');
            const forgotPasswordLink = document.getElementById('forgot-password-link');

            // Elementos de Register Screen
            const registerNameInput = document.getElementById('register-name');
            const registerEmailInput = document.getElementById('register-email');
            const registerPasswordInput = document.getElementById('register-password');
            const registerConfirmPasswordInput = document.getElementById('register-confirm-password');
            const registerButton = document.getElementById('register-button');
            const loginFromRegisterButton = document.getElementById('login-from-register-button');
            const registerErrorMessage = document.getElementById('register-error-message');

            // Controles de Medios Globales
            const backgroundVideo = document.getElementById('background-video');
            const backgroundMusic = document.getElementById('background-music');
            const playMusicButton = document.getElementById('play-music-button');
            const pauseMusicButton = document.getElementById('pause-music-button');
            let isMusicPlaying = false;

            // Selector de Idioma Global
            const languageSelect = document.getElementById('language-select');

            // --- Diccionario de idiomas ---
            const translations = {
                es: {
                    welcomeTitle: 'BIENVENIDO A BINGO VIP BOLIVIA',
                    sloganText: 'Tu destino definitivo para la diversión y grandes premios',
                    loadingMessage: 'Cargando recursos...',
                    startScreenButton: 'INICIAR JUEGO',
                    loginTitle: 'INICIAR SESIÓN',
                    registerTitle: 'REGISTRARSE',
                    loginEmailPlaceholder: 'Correo electrónico',
                    loginPasswordPlaceholder: 'Contraseña',
                    loginButton: 'INICIAR SESIÓN',
                    registerFromLoginButton: 'REGISTRARSE',
                    forgotPasswordText: '¿Olvidaste tu contraseña?',
                    termsLoginText: 'Al iniciar sesión, aceptas nuestros Términos y Condiciones.',
                    registerNamePlaceholder: 'Nombre Completo',
                    registerEmailPlaceholder: 'Correo electrónico',
                    registerPasswordPlaceholder: 'Contraseña',
                    registerConfirmPasswordPlaceholder: 'Confirmar Contraseña',
                    registerButton: 'CREAR CUENTA',
                    loginFromRegisterButton: 'YA TENGO CUENTA',
                    termsRegisterText: 'Al registrarte, aceptas nuestros Términos y Condiciones.',
                    lobbyBackText: 'Volver a Inicio',
                    settingsText: 'Configuración',
                    lobbyTitle: 'SELECCIONA TU SALA DE JUEGO',
                    playSala: 'JUGAR EN ESTA SALA',
                    legalWarningText: 'Juego con responsabilidad. Solo para mayores de 18 años.',
                    balanceInsufficient: 'Balance insuficiente. Necesitas $',
                    toPlayIn: ' para jugar en la ',
                    yourBalanceIs: '. Tu balance actual es $',
                    salaNotFound: 'Error: Sala no encontrada.',
                    firebaseNotInit: 'Error: Firebase (Auth/DB) no está disponible. Recarga la página.',
                    mustLogin: 'Debes iniciar sesión para jugar. Redirigiendo a inicio.',
                    updateBalanceError: 'Error al actualizar balance o entrar a sala. Por favor, intenta de nuevo.',
                    registerFillFields: 'Por favor, rellena todos los campos.',
                    passwordsMismatch: 'Las contraseñas no coinciden.',
                    passwordTooWeak: 'La contraseña debe tener al menos 6 caracteres.',
                    emailInUse: 'Este correo electrónico ya está en uso. Por favor, usa otro o inicia sesión.',
                    invalidEmailFormat: 'El formato del correo electrónico es inválido.',
                    registrationSuccessful: '¡Registro exitoso! ¡Bienvenido a Bingo VIP Bolivia!',
                    loginSuccessful: '¡Inicio de sesión exitoso!',
                    failedToLoadUserData: 'Error al cargar tus datos. Recarga o contacta soporte.',
                    noUserDataFound: 'Error: No se encontraron tus datos. Recarga o contacta soporte.',
                    authServicesNotReady: 'Error crítico: El sistema de autenticación no está listo. Recarga la página.'
                },
                en: {
                    welcomeTitle: 'WELCOME TO BINGO VIP BOLIVIA',
                    sloganText: 'Your ultimate destination for fun and big prizes',
                    loadingMessage: 'Loading resources...',
                    startScreenButton: 'START GAME',
                    loginTitle: 'SIGN IN',
                    registerTitle: 'REGISTER',
                    loginEmailPlaceholder: 'Email',
                    loginPasswordPlaceholder: 'Password',
                    loginButton: 'SIGN IN',
                    registerFromLoginButton: 'REGISTER',
                    forgotPasswordText: 'Forgot your password?',
                    termsLoginText: 'By signing in, you agree to our Terms and Conditions.',
                    registerNamePlaceholder: 'Full Name',
                    registerEmailPlaceholder: 'Email',
                    registerPasswordPlaceholder: 'Password',
                    registerConfirmPasswordPlaceholder: 'Confirm Password',
                    registerButton: 'CREATE ACCOUNT',
                    loginFromRegisterButton: 'ALREADY HAVE AN ACCOUNT',
                    termsRegisterText: 'By registering, you agree to our Terms and Conditions.',
                    lobbyBackText: 'Back to Home',
                    settingsText: 'Settings',
                    lobbyTitle: 'SELECT YOUR GAME ROOM',
                    playSala: 'PLAY IN THIS ROOM',
                    legalWarningText: 'Play responsibly. For ages 18+ only.',
                    balanceInsufficient: 'Insufficient balance. You need $',
                    toPlayIn: ' to play in ',
                    yourBalanceIs: '. Your current balance is $',
                    salaNotFound: 'Error: Room not found.',
                    firebaseNotInit: 'Error: Firebase (Auth/DB) not initialized. Reload page.',
                    mustLogin: 'You must sign in to play. Redirecting to home.',
                    updateBalanceError: 'Error updating balance or entering room. Please try again.',
                    registerFillFields: 'Please fill in all fields.',
                    passwordsMismatch: 'Passwords do not match.',
                    passwordTooWeak: 'Password must be at least 6 characters.',
                    emailInUse: 'This email is already in use. Please use another or sign in.',
                    invalidEmailFormat: 'Invalid email format.',
                    registrationSuccessful: 'Registration successful! Welcome to Bingo VIP Bolivia!',
                    loginSuccessful: 'Sign in successful!',
                    failedToLoadUserData: 'Error loading user data. Reload or contact support.',
                    noUserDataFound: 'Error: No user data found. Reload or contact support.',
                    authServicesNotReady: 'Critical error: Authentication system not ready. Reload page.'
                }
            };
            
            // --- Helper para mostrar/ocultar pantallas ---
            function showScreen(screenId) {
                document.querySelectorAll('.app-screen').forEach(screen => {
                    if (screen.id === screenId) {
                        screen.classList.remove('hidden');
                        screen.classList.add('fade-in');
                        screen.classList.remove('fade-out');
                    } else {
                        screen.classList.add('hidden');
                        screen.classList.remove('fade-in');
                        screen.classList.add('fade-out');
                    }
                });
            }

            // --- Funciones para manejar textos de idioma ---
            const textElements = {
                welcomeTitle: document.getElementById('welcomeTitle'),
                sloganText: document.getElementById('sloganText'),
                loadingMessage: document.getElementById('loadingMessage'),
                startScreenButton: document.getElementById('start-game-button'), // Asegúrate que el ID exista
                loginTitle: document.getElementById('loginTitle'),
                registerTitle: document.getElementById('registerTitle'),
                loginEmailInput: document.getElementById('login-email'), // Para el placeholder
                loginPasswordInput: document.getElementById('login-password'), // Para el placeholder
                loginButton: document.getElementById('login-button'),
                registerFromLoginButton: document.getElementById('register-from-login-button'),
                forgotPasswordText: document.getElementById('forgotPasswordText'),
                termsLoginText: document.getElementById('termsLoginText'),
                registerNameInput: document.getElementById('register-name'), // Para el placeholder
                registerEmailInput: document.getElementById('register-email'), // Para el placeholder
                registerPasswordInput: document.getElementById('register-password'), // Para el placeholder
                registerConfirmPasswordInput: document.getElementById('register-confirm-password'), // Para el placeholder
                registerButton: document.getElementById('register-button'),
                loginFromRegisterButton: document.getElementById('login-from-register-button'),
                termsRegisterText: document.getElementById('termsRegisterText'),
                lobbyBackText: document.getElementById('lobbyBackText'),
                settingsText: document.getElementById('settingsText'),
                lobbyTitle: document.getElementById('lobbyTitle'),
                // Más elementos de texto para lobby y juego se agregarían aquí
            };
            
            function updateTexts(lang) {
                const t = translations[lang];
                if (!t) return;

                Object.keys(textElements).forEach(key => {
                    const element = textElements[key];
                    if (element) {
                        if (element.tagName === 'INPUT' && (key.includes('Placeholder'))) {
                            element.placeholder = t[key];
                        } else if (key === 'forgotPasswordText' || key === 'termsLoginText' || key === 'termsRegisterText' || key === 'supportText') {
                            // Manejar enlaces dentro del texto
                            let text = t[key];
                            if (key === 'supportText') {
                                text = text.replace('Contacto con soporte', '<a href="#" id="linkSoporte">Contacto con soporte</a>');
                            } else if (key === 'forgotPasswordText') {
                                text = text.replace('Recuperar', '<a href="#" id="forgot-password-link">Recuperar</a>');
                            } else if (key === 'termsLoginText') {
                                text = text.replace('Términos y Condiciones', '<a href="#" id="terms-login-link">Términos y Condiciones</a>');
                            } else if (key === 'termsRegisterText') {
                                text = text.replace('Términos y Condiciones', '<a href="#" id="terms-register-link">Términos y Condiciones</a>');
                            }
                            element.innerHTML = text; // Usar innerHTML para mantener el enlace
                        }
                        else {
                            element.textContent = t[key];
                        }
                    }
                });
                
                // Asegurarse de que los event listeners de los enlaces se re-asignen si el innerHTML cambia
                if (document.getElementById('linkSoporte')) document.getElementById('linkSoporte').addEventListener('click', handleSupportClick);
                if (document.getElementById('forgot-password-link')) document.getElementById('forgot-password-link').addEventListener('click', handleForgotPasswordClick);
                if (document.getElementById('terms-login-link')) document.getElementById('terms-login-link').addEventListener('click', handleTermsClick);
                if (document.getElementById('terms-register-link')) document.getElementById('terms-register-link').addEventListener('click', handleTermsClick);


                // Actualizar textos de botones específicos en las salas del lobby (si ya están creadas)
                document.querySelectorAll('.btn-bingo span').forEach(span => {
                    const salaId = span.closest('.sala-card').id;
                    if (t[`playSala${salaId.split('-')[1]}`]) {
                        span.textContent = t.playSala;
                    }
                });

                // Actualizar placeholders que no se manejan con textContent
                if (textElements.loginEmailInput) textElements.loginEmailInput.placeholder = t.loginEmailPlaceholder;
                if (textElements.loginPasswordInput) textElements.loginPasswordInput.placeholder = t.loginPasswordPlaceholder;
                if (textElements.registerNameInput) textElements.registerNameInput.placeholder = t.registerNamePlaceholder;
                if (textElements.registerEmailInput) textElements.registerEmailInput.placeholder = t.registerEmailPlaceholder;
                if (textElements.registerPasswordInput) textElements.registerPasswordInput.placeholder = t.registerPasswordPlaceholder;
                if (textElements.registerConfirmPasswordInput) textElements.registerConfirmPasswordInput.placeholder = t.registerConfirmPasswordPlaceholder;
            }

            // --- Control de Idioma ---
            if (languageSelect) {
                const initialLang = localStorage.getItem('appLang') || 'es';
                languageSelect.value = initialLang;
                updateTexts(initialLang);

                languageSelect.addEventListener('change', (event) => {
                    const selectedLang = event.target.value;
                    localStorage.setItem('appLang', selectedLang);
                    updateTexts(selectedLang);
                });
            }

            // --- Lógica de la barra de carga (Splash Screen) ---
            let percentage = 0;
            const loadInterval = setInterval(() => {
                percentage += 2;
                if (loadingBar) loadingBar.style.width = percentage + '%';
                if (loadingPercentage) loadingPercentage.textContent = percentage + '%';

                if (percentage >= 100) {
                    clearInterval(loadInterval);
                    if (loadingBarContainer) loadingBarContainer.classList.add('hidden');
                    if (document.getElementById('start-game-button')) { // El botón INICIAR JUEGO está en splash-screen
                        document.getElementById('start-game-button').classList.remove('hidden');
                    }
                    // Iniciar música aquí (muteada) si backgroundMusic es global y autoplay no funciona
                    if (backgroundMusic) {
                        backgroundMusic.play().catch(e => console.warn("No se pudo iniciar la música automáticamente:", e));
                        isMusicPlaying = true;
                        if (playMusicButton) playMusicButton.classList.add('hidden');
                        if (pauseMusicButton) pauseMusicButton.classList.remove('hidden');
                    }
                }
            }, 150);

            // --- Lógica del botón INICIAR JUEGO (Splash Screen) ---
            document.getElementById('start-game-button').addEventListener('click', () => {
                showScreen('login-screen'); // Muestra la pantalla de Login
            });

            // --- Lógica de Login ---
            if (loginButton) {
                loginButton.addEventListener('click', async () => {
                    const email = loginEmailInput.value;
                    const password = loginPasswordInput.value;
                    loginErrorMessage.textContent = '';

                    if (!email || !password) {
                        loginErrorMessage.textContent = translations[localStorage.getItem('appLang') || 'es'].registerFillFields;
                        return;
                    }

                    try {
                        await firebase.auth().signInWithEmailAndPassword(email, password);
                        alert(translations[localStorage.getItem('appLang') || 'es'].loginSuccessful);
                        // Redirigir a la pantalla del lobby (simulamos navegación a la sección)
                        showScreen('lobby-screen'); 
                        updateLobbyUI(); // Cargar datos del usuario en el lobby
                    } catch (error) {
                        console.error("Error al iniciar sesión:", error);
                        let errorMessage = translations[localStorage.getItem('appLang') || 'es'].updateBalanceError;
                        switch (error.code) {
                            case 'auth/invalid-email': errorMessage = translations[localStorage.getItem('appLang') || 'es'].invalidEmailFormat; break;
                            case 'auth/user-not-found':
                            case 'auth/wrong-password': errorMessage = translations[localStorage.getItem('appLang') || 'es'].loginButton; break; // Usar el texto del botón Iniciar Sesión para evitar una variable extra
                            case 'auth/user-disabled': errorMessage = 'Tu cuenta ha sido deshabilitada.'; break;
                            case 'auth/too-many-requests': errorMessage = 'Demasiados intentos de inicio de sesión. Intenta de nuevo más tarde.'; break;
                            case 'auth/invalid-credential': errorMessage = translations[localStorage.getItem('appLang') || 'es'].invalidCredential; break;
                            default: errorMessage = `Error: ${error.message}`; break;
                        }
                        loginErrorMessage.textContent = errorMessage;
                    }
                });
            }

            if (registerFromLoginButton) {
                registerFromLoginButton.addEventListener('click', () => showScreen('register-screen'));
            }
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); alert("Recuperación de contraseña en desarrollo."); });
            }

            // --- Lógica de Registro ---
            if (registerButton) {
                registerButton.addEventListener('click', async () => {
                    const name = registerNameInput.value;
                    const email = registerEmailInput.value;
                    const password = registerPasswordInput.value;
                    const confirmPassword = registerConfirmPasswordInput.value;
                    registerErrorMessage.textContent = '';

                    if (!name || !email || !password || !confirmPassword) {
                        registerErrorMessage.textContent = translations[localStorage.getItem('appLang') || 'es'].registerFillFields;
                        return;
                    }
                    if (password !== confirmPassword) {
                        registerErrorMessage.textContent = translations[localStorage.getItem('appLang') || 'es'].passwordsMismatch;
                        return;
                    }
                    if (password.length < 6) {
                        registerErrorMessage.textContent = translations[localStorage.getItem('appLang') || 'es'].passwordTooWeak;
                        return;
                    }

                    try {
                        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;

                        await firebase.firestore().collection('users').doc(user.uid).set({
                            nombreCompleto: name,
                            email: email,
                            avatar: 'avatar_default.png',
                            balance: 500, // Bono de registro inicial
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        alert(translations[localStorage.getItem('appLang') || 'es'].registrationSuccessful);
                        showScreen('login-screen'); // Volver a login después del registro exitoso
                    } catch (error) {
                        console.error("Error al registrar:", error);
                        let errorMessage = translations[localStorage.getItem('appLang') || 'es'].updateBalanceError;
                        switch (error.code) {
                            case 'auth/email-already-in-use': errorMessage = translations[localStorage.getItem('appLang') || 'es'].emailInUse; break;
                            case 'auth/invalid-email': errorMessage = translations[localStorage.getItem('appLang') || 'es'].invalidEmailFormat; break;
                            case 'auth/weak-password': errorMessage = translations[localStorage.getItem('appLang') || 'es'].passwordTooWeak; break;
                            default: errorMessage = `Error: ${error.message}`; break;
                        }
                        registerErrorMessage.textContent = errorMessage;
                    }
                });
            }
            if (loginFromRegisterButton) {
                loginFromRegisterButton.addEventListener('click', () => showScreen('login-screen'));
            }

            // --- Lógica del Lobby ---
            async function updateLobbyUI() {
                const user = firebase.auth().currentUser;
                if (!user) {
                    showScreen('login-screen');
                    alert(translations[localStorage.getItem('appLang') || 'es'].mustLogin);
                    return;
                }

                try {
                    const userRef = firebase.firestore().collection('users').doc(user.uid);
                    const userSnap = await userRef.get();

                    if (userSnap.exists) {
                        const userData = userSnap.data();
                        if (document.getElementById('user-balance')) document.getElementById('user-balance').textContent = `$${parseFloat(userData.balance).toFixed(2)}`;
                        if (document.getElementById('user-avatar') && userData.avatar) {
                            document.getElementById('user-avatar').src = userData.avatar;
                        } else if (document.getElementById('user-avatar')) {
                            document.getElementById('user-avatar').src = 'avatar_default.png';
                        }
                    } else {
                        alert(translations[localStorage.getItem('appLang') || 'es'].noUserDataFound);
                        showScreen('login-screen');
                    }
                } catch (error) {
                    console.error("Error al cargar datos de usuario en lobby:", error);
                    alert(translations[localStorage.getItem('appLang') || 'es'].failedToLoadUserData);
                    showScreen('login-screen');
                }
            }

            // --- Lógica de la Sala de Juego (Función global) ---
            window.seleccionarSala = async (salaId) => {
                const salaCard = document.getElementById(salaId);
                if (!salaCard) {
                    alert(translations[localStorage.getItem('appLang') || 'es'].salaNotFound);
                    return;
                }

                const costoCarton = parseFloat(salaCard.dataset.cost);
                const minBalance = parseFloat(salaCard.dataset.minBalance);
                const salaName = salaCard.dataset.name;

                const user = firebase.auth().currentUser;
                if (!user) {
                    alert(translations[localStorage.getItem('appLang') || 'es'].mustLogin);
                    showScreen('login-screen');
                    return;
                }

                const userRef = firebase.firestore().collection('users').doc(user.uid);
                const userSnap = await userRef.get();
                let currentBalance = 0;

                if (userSnap.exists) {
                    currentBalance = parseFloat(userSnap.data().balance);
                } else {
                    alert(translations[localStorage.getItem('appLang') || 'es'].noUserDataFound);
                    showScreen('login-screen');
                    return;
                }

                if (currentBalance < minBalance) {
                    alert(`${translations[localStorage.getItem('appLang') || 'es'].balanceInsufficient}$${minBalance.toFixed(2)}${translations[localStorage.getItem('appLang') || 'es'].toPlayIn}${salaName}. ${translations[localStorage.getItem('appLang') || 'es'].yourBalanceIs}$${currentBalance.toFixed(2)}`);
                    return;
                }

                try {
                    await firebase.firestore().runTransaction(async (transaction) => {
                        const sfDoc = await transaction.get(userRef);
                        if (!sfDoc.exists) {
                            throw "Documento de usuario no existe!";
                        }

                        const newBalance = parseFloat(sfDoc.data().balance) - costoCarton;
                        if (newBalance < 0) {
                            throw "Balance negativo inesperado. Operación cancelada.";
                        }

                        transaction.update(userRef, { balance: newBalance });
                    });

                    alert(`${translations[localStorage.getItem('appLang') || 'es'].playedInRoom} ${salaName}. ${translations[localStorage.getItem('appLang') || 'es'].costDeducted}$${costoCarton.toFixed(2)}.`);
                    localStorage.setItem('currentSalaId', salaId);
                    localStorage.setItem('currentSalaName', salaName);

                    showScreen('game-screen');
                    initializeGameScreen(); // Iniciar lógica del juego
                } catch (error) {
                    console.error("Error al actualizar balance o entrar a sala:", error);
                    alert(translations[localStorage.getItem('appLang') || 'es'].updateBalanceError);
                }
            };

            // --- Lógica de la Pantalla de Juego ---
            let currentBingoCard = []; // El cartón del jugador
            let calledNumbers = []; // Números que ya han sido cantados
            let gameInterval; // Para el temporizador de llamado de números
            const BINGO_NUMBERS = 75; // Números totales en el bingo (1-75)
            const BINGO_CARD_SIZE = 25; // Tamaño del cartón (5x5)

            async function initializeGameScreen() {
                const salaActualDisplay = document.getElementById('game-sala-actual-display');
                const gameTimerDisplay = document.getElementById('game-timer');
                const locutorAvatar = document.getElementById('locutor-avatar');
                const numeroCantadoDisplay = document.getElementById('numero-cantado-display');
                const numerosCantadosGrid = document.getElementById('numeros-cantados-grid');
                const playerBingoCardElement = document.getElementById('player-bingo-card');
                const buyNewCardButton = document.getElementById('buy-new-card-button');
                const checkBingoButton = document.getElementById('check-bingo-button');
                const backToLobbyButton = document.getElementById('game-back-to-lobby-button');

                if (salaActualDisplay) {
                    salaActualDisplay.textContent = `Sala: ${localStorage.getItem('currentSalaName') || 'Desconocida'}`;
                }
                if (locutorAvatar) {
                    // Cargar avatar del usuario logueado como locutor
                    const user = firebase.auth().currentUser;
                    if (user) {
                        const userSnap = await firebase.firestore().collection('users').doc(user.uid).get();
                        if (userSnap.exists && userSnap.data().avatar) {
                            locutorAvatar.src = userSnap.data().avatar;
                        } else {
                            locutorAvatar.src = 'avatar_locutor_default.png'; // Por defecto
                        }
                    }
                }
                
                generateNewBingoCard(playerBingoCardElement, checkBingoButton);
                startGameRound(gameTimerDisplay, numeroCantadoDisplay, numerosCantadosGrid, playerBingoCardElement);
                
                if (buyNewCardButton) {
                    buyNewCardButton.addEventListener('click', () => {
                        alert("Comprar nuevo cartón en desarrollo.");
                        // Lógica de descuento de balance y generación
                        generateNewBingoCard(playerBingoCardElement, checkBingoButton);
                    });
                }
                if (checkBingoButton) {
                    checkBingoButton.addEventListener('click', () => {
                        alert("Verificación de BINGO en desarrollo.");
                        // Lógica de verificación
                    });
                }
                if (backToLobbyButton) {
                    backToLobbyButton.addEventListener('click', () => {
                        clearInterval(gameInterval); // Detener el juego al salir
                        showScreen('lobby-screen');
                    });
                }
            }
            
            function generateNewBingoCard(cardElement, bingoButton) {
                if (!cardElement) return;
                cardElement.innerHTML = '';
                currentBingoCard = [];
                
                const allNumbers = Array.from({ length: BINGO_NUMBERS }, (_, i) => i + 1);
                const shuffledNumbers = allNumbers.sort(() => 0.5 - Math.random()).slice(0, BINGO_CARD_SIZE);

                shuffledNumbers.forEach(num => {
                    const cell = document.createElement('div');
                    cell.classList.add('bingo-cell');
                    cell.textContent = num;
                    cell.dataset.number = num;
                    cell.addEventListener('click', () => markNumberOnCard(cell));
                    cardElement.appendChild(cell);
                    currentBingoCard.push({ number: num, marked: false });
                });
                if(bingoButton) bingoButton.disabled = false;
            }

            function markNumberOnCard(cell) {
                const number = parseInt(cell.dataset.number);
                const cardItem = currentBingoCard.find(item => item.number === number);
                if (cardItem && calledNumbers.includes(number)) {
                    cardItem.marked = !cardItem.marked;
                    cell.classList.toggle('marked', cardItem.marked);
                } else {
                    alert("El número no ha sido cantado aún.");
                }
            }

            function startGameRound(timerDisplay, numDisplay, historyGrid, cardElement) {
                let numbersPool = Array.from({ length: BINGO_NUMBERS }, (_, i) => i + 1);
                numbersPool.sort(() => 0.5 - Math.random());
                calledNumbers = [];
                numDisplay.textContent = '';
                historyGrid.innerHTML = '';
                
                clearInterval(gameInterval);

                let callIndex = 0;
                gameInterval = setInterval(() => {
                    if (callIndex < numbersPool.length) {
                        const num = numbersPool[callIndex];
                        calledNumbers.push(num);
                        numDisplay.textContent = num;
                        updateCalledNumbersGrid(historyGrid, num);

                        document.querySelectorAll('.bingo-cell').forEach(cell => {
                            if (parseInt(cell.dataset.number) === num) {
                                cell.classList.add('called');
                            }
                        });
                        callIndex++;
                    } else {
                        clearInterval(gameInterval);
                        alert("Todos los números cantados. Fin de la partida.");
                    }
                }, 2000); // Canta cada 2 segundos
            }

            function updateCalledNumbersGrid(gridElement, number) {
                if (!gridElement) return;
                const numDiv = document.createElement('div');
                numDiv.classList.add('called-number-item');
                numDiv.textContent = number;
                gridElement.appendChild(numDiv);
                gridElement.scrollTop = gridElement.scrollHeight;
            }


            // --- Global Media Controls ---
            playMusicButton.addEventListener('click', () => {
                backgroundMusic.play().catch(e => console.error("Error al reproducir música:", e));
                isMusicPlaying = true;
                playMusicButton.classList.add('hidden');
                pauseMusicButton.classList.remove('hidden');
            });

            pauseMusicButton.addEventListener('click', () => {
                backgroundMusic.pause();
                isMusicPlaying = false;
                playMusicButton.classList.remove('hidden');
                pauseMusicButton.classList.add('hidden');
            });
            // Opcional: Auto-play muted video if browser allows
            backgroundVideo.play().catch(e => console.warn("Video autoplay blocked:", e));


            // --- Lógica del Selector de Idioma ---
            languageSelect.addEventListener('change', (event) => {
                const selectedLang = event.target.value;
                localStorage.setItem('appLang', selectedLang);
                updateTexts(selectedLang);
            });
            // Establecer idioma inicial al cargar
            updateTexts(localStorage.getItem('appLang') || 'es');
        });
        
        // --- Firebase Initialization (from firebase-config.js) ---
        // Se asume que firebase-app-compat.js ya cargó 'firebase' globalmente
        const firebaseConfig = {
            apiKey: "AIzaSyDhXhwJXEpeBBB23l49XRaxiRT2-9mz0KI", 
            authDomain: "bingo-vip-bolivia-df2db.firebaseapp.com",
            projectId: "bingo-vip-bolivia-df2db",
            storageBucket: "bingo-vip-bolivia-df2db.appspot.com",
            messagingSenderId: "1015694294025",
            appId: "1:1015694294025:web:5d254b0374e26210214842",
            measurementId: "G-G6402N020Z"
        };
        let app;
        try {
            if (typeof firebase !== 'undefined' && (!firebase.apps || firebase.apps.length === 0)) {
                app = firebase.initializeApp(firebaseConfig);
            } else if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                app = firebase.apps[0];
            } else {
                throw new Error("El objeto global 'firebase' no está definido. SDK no cargado.");
            }
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            alert("CRÍTICO: Error al inicializar Firebase en el script principal. " + error.message);
        }
        if (app) {
            window.auth = firebase.auth();
            window.db = firebase.firestore();
        }

        // --- Core Screen Navigation Logic ---
        function showScreen(screenId) {
            document.querySelectorAll('.app-screen').forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.remove('hidden');
                    screen.classList.add('fade-in');
                    screen.classList.remove('fade-out');
                } else {
                    screen.classList.add('hidden');
                    screen.classList.remove('fade-in');
                    screen.classList.add('fade-out');
                }
            });
            // Special handling for splash screen to ensure video is visible
            if (screenId === 'splash-screen') {
                if (backgroundVideo) backgroundVideo.play().catch(e => console.warn("Video autoplay blocked on splash return:", e));
            }
        }

        // --- Initial App Load Logic ---
        const splashScreen = document.getElementById('splash-screen');
        const loginScreen = document.getElementById('login-screen');
        const registerScreen = document.getElementById('register-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        
        // Show splash screen initially
        showScreen('splash-screen');

        // Logic for splash screen transitions
        const loadingBarContainer = document.getElementById('loading-bar-container');
        const loadingBar = document.getElementById('loading-bar');
        const loadingPercentage = document.getElementById('loading-percentage');
        const loadingMessage = document.getElementById('loading-message');
        const startGameButton = document.getElementById('start-game-button');

        let percentage = 0;
        const loadInterval = setInterval(() => {
            percentage += 2;
            if (loadingBar) loadingBar.style.width = percentage + '%';
            if (loadingPercentage) loadingPercentage.textContent = percentage + '%';

            if (percentage >= 100) {
                clearInterval(loadInterval);
                if (loadingBarContainer) loadingBarContainer.classList.add('hidden');
                if (startGameButton) startGameButton.classList.remove('hidden');
            }
        }, 150);

        // --- Button Click Handlers ---
        if (startGameButton) {
            startGameButton.addEventListener('click', () => {
                showScreen('login-screen');
                // Play music/video on first user interaction
                if (backgroundVideo) backgroundVideo.play().catch(e => console.warn("Video play blocked on start:", e));
                if (backgroundMusic) backgroundMusic.play().catch(e => console.warn("Music play blocked on start:", e));
            });
        }

        // Login Screen Buttons
        if (document.getElementById('login-button')) {
            document.getElementById('login-button').addEventListener('click', async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorMessageElement = document.getElementById('login-error-message');
                errorMessageElement.textContent = '';
                if (!email || !password) {
                    errorMessageElement.textContent = "Por favor, ingresa correo y contraseña."; return;
                }
                try {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                    alert("Inicio de sesión exitoso!");
                    showScreen('lobby-screen');
                    // updateLobbyUI(); // Call updateLobbyUI when entering lobby
                } catch (error) {
                    errorMessageElement.textContent = `Error: ${error.message}`;
                }
            });
        }
        if (document.getElementById('register-from-login-button')) {
            document.getElementById('register-from-login-button').addEventListener('click', () => showScreen('register-screen'));
        }

        // Register Screen Buttons
        if (document.getElementById('register-button')) {
            document.getElementById('register-button').addEventListener('click', async () => {
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const errorMessageElement = document.getElementById('register-error-message');
                errorMessageElement.textContent = '';
                if (!name || !email || !password || !confirmPassword) {
                    errorMessageElement.textContent = "Por favor, rellena todos los campos."; return;
                }
                if (password !== confirmPassword) {
                    errorMessageElement.textContent = "Las contraseñas no coinciden."; return;
                }
                if (password.length < 6) {
                    errorMessageElement.textContent = "La contraseña debe tener al menos 6 caracteres."; return;
                }
                try {
                    const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                    await firebase.firestore().collection('users').doc(userCredential.user.uid).set({
                        nombreCompleto: name, email: email, avatar: 'avatar_default.png', balance: 500, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("¡Registro exitoso!");
                    showScreen('login-screen');
                } catch (error) {
                    errorMessageElement.textContent = `Error: ${error.message}`;
                }
            });
        }
        if (document.getElementById('login-from-register-button')) {
            document.getElementById('login-from-register-button').addEventListener('click', () => showScreen('login-screen'));
        }

        // --- Lobby Logic ---
        function updateLobbyUI() {
            // This function will fetch user balance and avatar when lobby screen is shown
            // Simplified, since showScreen handles transitions.
            console.log("Updating Lobby UI...");
            // You will add the actual logic to fetch user balance/avatar from Firebase here
            // For now, let's just make sure the elements exist.
            const userBalanceSpan = document.getElementById('user-balance');
            const userAvatarImg = document.getElementById('user-avatar');
            if (userBalanceSpan) userBalanceSpan.textContent = "$500.00"; // Placeholder
            if (userAvatarImg) userAvatarImg.src = "avatar_default.png"; // Placeholder
        }

        // Lobby buttons
        document.querySelectorAll('.btn-bingo').forEach(button => {
            button.addEventListener('click', async () => {
                const salaId = button.dataset.salaId;
                // Game entry logic here (balance check, deduction, show game screen)
                alert(`Entrando a sala ${salaId}. Lógica de juego en desarrollo.`);
                showScreen('game-screen');
            });
        });
    </script>
</body>
</html>
