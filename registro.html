<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selección de Juego - Bingo VIP Bolivia</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">

    <script type="module">
        // Importa las funciones necesarias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Tus credenciales de Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyDhXhwJXEpeBBB23l49XRaxiRT2-9mz0KI", 
          authDomain: "bingo-vip-bolivia-df2db.firebaseapp.com",
          projectId: "bingo-vip-bolivia-df2db",
          storageBucket: "bingo-vip-bolivia-df2db.firebasestorage.app",
          messagingSenderId: "310290230955",
          appId: "1:310290230955:web:3526c26c2800b43ffcd1ee",
          measurementId: "G-VRR7JSHY5G"
        };

        // Inicializa Firebase y obtiene las instancias de auth y db
        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.onAuthStateChanged = onAuthStateChanged;
        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc; 

        // *** ¡NUEVA ALERTA DE DEPURACIÓN CRÍTICA AQUÍ! ***
        alert("DEBUG HTML: Módulo de Firebase cargado en seleccion-juego.html");
        // ***********************************************

        // Lógica principal de seleccion-juego.js (ahora integrada aquí para depuración)
        document.addEventListener('DOMContentLoaded', () => {
            const backToLobbyBtn = document.getElementById('backToLobbyBtn');
            const levelsGrid = document.getElementById('levelsGrid');
            const currentUserBalanceElement = document.getElementById('currentUserBalance');

            let currentUser = null;
            let currentUserData = null;

            // Datos de ejemplo para las salas/niveles
            const gameLevels = [
                {
                    id: 'sala-bronce',
                    name: 'Sala Bronce',
                    cost: 1.00,
                    prize: 5.00,
                    locutor: 'Hombre Básico',
                    locutorAvatar: 'https://via.placeholder.com/50/8B4513/FFFFFF?text=HB',
                    description: 'Ideal para principiantes. ¡Gana tus primeras monedas!',
                    styleClass: 'casino-clasico'
                },
                {
                    id: 'sala-plata',
                    name: 'Sala Plata',
                    cost: 5.00,
                    prize: 25.00,
                    locutor: 'Mujer Básica',
                    locutorAvatar: 'https://via.placeholder.com/50/FFC0CB/000000?text=MB',
                    description: 'Un poco más de emoción y mayores premios.',
                    styleClass: 'las-vegas'
                },
                {
                    id: 'sala-oro',
                    name: 'Sala Oro',
                    cost: 20.00,
                    prize: 100.00,
                    locutor: 'Hombre Elegante',
                    locutorAvatar: 'https://via.placeholder.com/50/DAA520/000000?text=HE',
                    description: 'Para jugadores con experiencia. ¡Grandes apuestas, grandes ganancias!',
                    styleClass: 'hollywood'
                },
                {
                    id: 'sala-diamante',
                    name: 'Sala Diamante',
                    cost: 100.00,
                    prize: 500.00,
                    locutor: 'Mujer Glamour',
                    locutorAvatar: 'https://via.placeholder.com/50/B9F2FF/000000?text=MG',
                    description: '¡Solo para los VIP! El mayor desafío y el premio supremo.',
                    styleClass: 'cibernetico'
                }
            ];

            function loadGameLevels() {
                if (!levelsGrid) { console.error("levelsGrid element not found!"); return; }
                levelsGrid.innerHTML = '';
                gameLevels.forEach(level => {
                    const levelCard = document.createElement('div');
                    levelCard.classList.add('level-card', level.styleClass);
                    levelCard.dataset.levelId = level.id;

                    levelCard.innerHTML = `
                        <div class="level-header">
                            <img src="${level.locutorAvatar}" alt="${level.locutor}" class="locutor-avatar">
                            <h3>${level.name}</h3>
                        </div>
                        <p>${level.description}</p>
                        <p class="costo">Costo del Cartón: <i class="fas fa-dollar-sign"></i> ${level.cost.toFixed(2)}</p>
                        <p class="premio">Premio por Bingo: <i class="fas fa-trophy"></i> ${level.prize.toFixed(2)}</p>
                        <button class="play-level-btn"><i class="fas fa-play"></i> Jugar en esta Sala</button>
                    `;
                    levelsGrid.appendChild(levelCard);
                });

                document.querySelectorAll('.play-level-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const levelId = event.target.closest('.level-card').dataset.levelId;
                        const entryCost = parseFloat(event.target.closest('.level-card').querySelector('.costo').textContent.replace(/[^0-9.]/g, ''));
                        handlePlayLevel(levelId, entryCost);
                    });
                });
            }

            async function handlePlayLevel(levelId, entryCost) {
                if (!currentUser || !currentUserData) {
                    alert('Debes iniciar sesión para jugar.');
                    window.location.href = 'index.html';
                    return;
                }

                const selectedLevel = gameLevels.find(level => level.id === levelId);

                if (!selectedLevel) {
                    alert('Nivel de juego no encontrado.');
                    return;
                }

                if (currentUserData.balance < selectedLevel.cost) {
                    alert(`Saldo insuficiente! Necesitas $${selectedLevel.cost.toFixed(2)} para jugar en la ${selectedLevel.name}. Tu saldo actual es $${currentUserData.balance.toFixed(2)}.`);
                    return;
                }

                const newBalance = currentUserData.balance - selectedLevel.cost;

                try {
                    const userDocRef = window.doc(window.db, "users", currentUser.uid);
                    await window.updateDoc(userDocRef, {
                        balance: newBalance
                    });
                    currentUserData.balance = newBalance;
                    updateBalanceDisplay(newBalance);

                    alert(`¡Has entrado a la ${selectedLevel.name}! Costo: $${selectedLevel.cost.toFixed(2)}. Tu nuevo saldo es: $${newBalance.toFixed(2)}.`);
                    console.log(`Usuario ${currentUser.email} entró a ${selectedLevel.name}. Nuevo balance: ${newBalance}`);
                    
                } catch (error) {
                    console.error("Error al actualizar el balance:", error);
                    let debugErrorMessage = "Error al intentar jugar en la sala.";
                    debugErrorMessage += "\nDetalle: " + error.message;
                    if (error.code) {
                        debugErrorMessage += "\nCódigo: " + error.code;
                    }
                    alert(debugErrorMessage + "\n\nPor favor, toma una captura de esta alerta.");
                }
            }

            function updateBalanceDisplay(balance) {
                if (currentUserBalanceElement) {
                    currentUserBalanceElement.innerHTML = `<i class="fas fa-dollar-sign"></i> ${balance ? balance.toFixed(2) : '0.00'}`;
                }
            }

            if (window.onAuthStateChanged && window.auth && window.db) {
                window.onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        console.log("Usuario logueado en seleccion-juego:", user.uid);
                        try {
                            const userDocRef = window.doc(window.db, "users", user.uid);
                            const userDocSnap = await window.getDoc(userDocRef);

                            if (userDocSnap.exists()) {
                                currentUserData = userDocSnap.data();
                                updateBalanceDisplay(currentUserData.balance);
                            } else {
                                console.log("No se encontraron datos de usuario en Firestore.");
                                updateBalanceDisplay(0);
                            }
                            loadGameLevels(); 
                        } catch (error) {
                            console.error("Error al obtener datos de usuario de Firestore o cargar niveles:", error);
                            let debugErrorMessage = "Error Crítico al cargar la página de selección.";
                            debugErrorMessage += "\nDetalle: " + error.message;
                            if (error.code) {
                                debugErrorMessage += "\nCódigo: " + error.code;
                            }
                            alert(debugErrorMessage + "\
